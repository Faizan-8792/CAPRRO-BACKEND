<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Document Requests - Admin</title>
  <link rel="stylesheet" href="admin.css" />
  <style>
    .dr-grid { display:flex; gap:18px; align-items:flex-start }
    .dr-form, .dr-list { background: rgba(255,255,255,0.03); padding:16px; border-radius:8px; flex:1 }
    .dr-items { margin-top:8px }
    .chip { display:inline-block; padding:4px 8px; border-radius:12px; background:#0ea5e9; color:#fff; margin-right:6px; font-size:12px }
  </style>
</head>
<body>
  <h3>Document Requests</h3>
  <div class="dr-grid">
    <div class="dr-form">
      <h4>Create Request</h4>
      <label>Client ID or Name</label>
      <input id="clientId" placeholder="client id or name" style="width:100%" />
      <label style="margin-top:8px">Due date</label>
      <input id="dueDate" type="date" style="width:100%" />
      <label style="margin-top:8px">Items (comma separated)</label>
      <input id="items" placeholder="GSTR-1,Bank statement,invoices" style="width:100%" />
      <div style="margin-top:10px; text-align:right">
        <button id="createReqBtn" class="btn btn-primary">Create Request</button>
      </div>
      <div id="createStatus" style="margin-top:8px" class="small-label"></div>
    </div>

    <div class="dr-list">
      <h4>Pending & Recent Requests</h4>
      <div id="requestsList">Loading…</div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    const token = localStorage.getItem('caproadminjwt');

    async function loadRequests(){
      const el = document.getElementById('requestsList');
      el.innerHTML = 'Loading…';
      try{
        const res = await fetch(API_BASE + '/document-requests', { headers: { Authorization: 'Bearer ' + token } });
        const data = await res.json();
        if(!data.ok) throw new Error(data.error||'Failed');
        const rows = data.data || [];
        if(!rows.length) { el.innerHTML = '<div class="muted">No requests</div>'; return; }
        el.innerHTML = rows.map(r => {
          const items = (r.items||[]).map(i=>`<span class="chip">${i.label||i.key}:${i.status}</span>`).join(' ');
          return `<div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)"><strong>${r.clientName||r.clientId}</strong> <div class="muted small">${new Date(r.createdAt).toLocaleString()}</div><div class="dr-items">${items}</div><div style="margin-top:6px">Status: <em>${r.status}</em></div></div>`
        }).join('');
      }catch(e){ el.innerHTML = '<div class="error">'+(e.message||e)+'</div>' }
    }

    document.getElementById('createReqBtn').addEventListener('click', async()=>{
      const cid = document.getElementById('clientId').value.trim();
      const due = document.getElementById('dueDate').value;
      const itemsRaw = document.getElementById('items').value.trim();
      const statusEl = document.getElementById('createStatus');
      if(!cid || !itemsRaw) { statusEl.textContent = 'Client and items required'; statusEl.className='small-label err'; return; }
      const items = itemsRaw.split(',').map(s=>({ key: s.trim().replace(/\s+/g,'_').toUpperCase(), label: s.trim() }));
      try{
        statusEl.textContent = 'Creating...';
        const res = await fetch(API_BASE + '/document-requests', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization: 'Bearer ' + token }, body: JSON.stringify({ clientId: cid, clientName: cid, items, dueDateISO: due? new Date(due+'T00:00:00').toISOString():undefined }) });
        const data = await res.json();
        if(!data.ok) throw new Error(data.error||'Failed');
        statusEl.textContent = 'Created'; statusEl.className='small-label ok';
        document.getElementById('clientId').value=''; document.getElementById('items').value=''; document.getElementById('dueDate').value='';
        loadRequests();
      }catch(e){ statusEl.textContent = e.message || e; statusEl.className='small-label err'; }
    });

    loadRequests();
  </script>
</body>
</html>
